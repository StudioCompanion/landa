<script>
	import { getImageProps } from '$lib/sanity';
	import { onMount } from 'svelte';
	import { fade } from 'svelte/transition';
	import { animate } from 'framer-motion';
	import Cookies from 'js-cookie';
	export let images;
	let visible = 0;
	let countdown = 1000;
	let hideImages = true;
	let hide = false;
	let logoVisible = false;

	const altRun = () => {
		hideImages = false;
		animate(0, 80, {
			type: 'tween',
			duration: 10,
			ease: [0.25, 0.03, 0.84, 0],
			onComplete: () => {
				hideImages = true;
				setTimeout(() => {
					hide = true;
					Cookies.set('splashscreen', true);
				}
				, 50);
			},
			onUpdate: v => {
				visible = Math.floor(v);
			},
		});
	};

	const preload = async () => {
		const processedImages = images.images.map(
			(image) => getImageProps({ image, maxWidth: 2000 })
		);
		const promises = [];
		processedImages.forEach(({src}) => {
			promises.push(
				new Promise((resolve, reject) => {
					const img = new Image();
					img.onload = () => {
						resolve();
					};
					img.onerror = () => {
						reject();
					};
					img.src = src;
				})
			);
		});
		await Promise.all(promises);
	};

	let timeout = new Promise((resolve) => {
			setTimeout(() => {
				resolve();
			}, 3000);
		});

	onMount(() => {
		logoVisible = true;
		// Wait for the timeout and the preload to finish, whichever takes longer
		Promise.all([timeout, preload()]).then(() => {
			logoVisible = false;
			altRun();
		});
	});
</script>

{#if !hide}
	<div out:fade class="splashscreen">
		<div class="splashscreen-inner">
			{#if !hideImages}
				<div in:fade>
					{#each images.images as image, index}
						<img
							alt=""
							src={getImageProps({ image: image, maxWidth: 2000 }).src}
							class={`splash-image${visible % images.images.length === index && !hideImages ? " visible" : ""}`}
						/>
					{/each}
				</div>
			{/if}
		</div>

		<div in:fade>
			<svg
				width="630"
				height="80"
				viewBox="0 0 630 80"
				fill="none"
				xmlns="http://www.w3.org/2000/svg"
				class={`splashscreen-logo${logoVisible ? " visible" : ""}`}
				><path
					d="M38.824 78H.104V2.805h17.578v60.01h21.142V78ZM64.752 50.022h10.107L69.83 17.209l-5.078 32.813ZM43.023 78 59.43 2.805h20.898L96.54 78H78.961l-2.197-14.404H62.945L60.748 78H43.023ZM103.424 78V2.805h18.31l14.6 46.386c-.586-7.812-1.025-14.55-1.318-20.214-.261-5.665-.391-10.45-.391-14.356V2.805h15.674V78h-18.36l-14.697-47.803a371.827 371.827 0 0 1 1.465 18.116c.358 5.826.537 11.49.537 16.992V78h-15.82ZM162.604 78V2.805h40.917v14.6h-23.437v13.818h21.631V46.31h-21.631v16.407h23.437V78h-40.917ZM265.191 25.314c1.888-1.27 3.288-2.604 4.2-4.003.944-1.433 1.416-2.93 1.416-4.493 0-1.4-.44-2.522-1.319-3.369-.879-.846-2.034-1.27-3.467-1.27-1.367 0-2.457.424-3.271 1.27-.814.814-1.221 1.905-1.221 3.272 0 1.334.277 2.669.83 4.004.554 1.302 1.498 2.832 2.832 4.59Zm6.104 37.403-10.986-17.432c-1.726 1.693-3.011 3.418-3.858 5.176a12.554 12.554 0 0 0-1.221 5.42c0 2.962.831 5.371 2.491 7.226 1.66 1.856 3.825 2.784 6.494 2.784 1.009 0 2.083-.26 3.223-.782 1.171-.52 2.457-1.318 3.857-2.392ZM281.5 78l-2.783-3.809c-2.572 1.888-5.257 3.288-8.057 4.2-2.767.944-5.713 1.416-8.838 1.416-6.608 0-11.946-2.067-16.015-6.201-4.069-4.135-6.104-9.506-6.104-16.114 0-4.785 1.058-9.066 3.174-12.842 2.148-3.808 5.599-7.552 10.352-11.23-1.856-2.735-3.239-5.387-4.151-7.96-.911-2.57-1.367-5.06-1.367-7.47 0-4.948 1.774-9.033 5.322-12.256C256.614 2.512 261.171.9 266.705.9c5.566 0 10.026 1.465 13.379 4.395 3.353 2.93 5.029 6.836 5.029 11.719 0 3.873-1.009 7.356-3.027 10.449-1.986 3.092-5.078 5.94-9.277 8.545l7.421 12.011a32.814 32.814 0 0 0 1.612-4.98c.423-1.66.683-3.304.781-4.932h13.086a48.046 48.046 0 0 1-2.002 11.915c-1.172 3.906-2.832 7.73-4.98 11.474L299.127 78H281.5ZM350.689 50.022h10.108l-5.029-32.813-5.079 32.813ZM328.961 78l16.406-75.195h20.899L382.477 78h-17.579l-2.197-14.404h-13.818L346.686 78h-17.725ZM387.066 52.512h16.114v2.197c0 4.134.488 7.047 1.465 8.74.976 1.693 2.62 2.54 4.931 2.54 1.856 0 3.32-.636 4.395-1.905 1.074-1.302 1.611-3.06 1.611-5.274 0-3.645-2.62-7.145-7.861-10.498a77.07 77.07 0 0 0-1.953-1.318c-.163-.097-.44-.277-.83-.537-7.064-4.753-11.459-8.333-13.184-10.742-1.237-1.823-2.181-3.874-2.832-6.153-.651-2.278-.977-4.768-.977-7.47 0-6.576 1.905-11.735 5.713-15.479 3.809-3.743 9.05-5.615 15.723-5.615 7.259 0 12.793 1.84 16.601 5.518 3.842 3.678 5.762 9 5.762 15.966 0 .293-.016.7-.049 1.221-.032.521-.049.928-.049 1.22h-15.771v-.927c0-3.288-.521-5.778-1.563-7.47-1.009-1.693-2.49-2.54-4.443-2.54-1.66 0-2.995.602-4.004 1.807-1.009 1.172-1.513 2.734-1.513 4.688 0 3.19 2.864 6.575 8.593 10.156a511.22 511.22 0 0 0 2.393 1.562c.456.26 1.09.668 1.904 1.22 6.153 3.907 10.091 7.195 11.817 9.864 1.074 1.725 1.888 3.695 2.441 5.908.586 2.181.879 4.558.879 7.13 0 7.519-1.953 13.313-5.859 17.382-3.907 4.07-9.489 6.104-16.749 6.104-7.617 0-13.346-1.937-17.187-5.81-3.809-3.907-5.713-9.701-5.713-17.384V55.1c.033-.554.098-1.416.195-2.588ZM439.605 52.512h16.114v2.197c0 4.134.488 7.047 1.465 8.74.976 1.693 2.62 2.54 4.931 2.54 1.856 0 3.321-.636 4.395-1.905 1.074-1.302 1.611-3.06 1.611-5.274 0-3.645-2.62-7.145-7.861-10.498a77.07 77.07 0 0 0-1.953-1.318c-.163-.097-.44-.277-.83-.537-7.064-4.753-11.459-8.333-13.184-10.742-1.237-1.823-2.181-3.874-2.832-6.153-.651-2.278-.977-4.768-.977-7.47 0-6.576 1.905-11.735 5.713-15.479 3.809-3.743 9.05-5.615 15.723-5.615 7.259 0 12.793 1.84 16.601 5.518 3.842 3.678 5.762 9 5.762 15.966 0 .293-.016.7-.049 1.221-.032.521-.048.928-.048 1.22h-15.772v-.927c0-3.288-.521-5.778-1.562-7.47-1.01-1.693-2.491-2.54-4.444-2.54-1.66 0-2.995.602-4.004 1.807-1.009 1.172-1.513 2.734-1.513 4.688 0 3.19 2.864 6.575 8.593 10.156a511.22 511.22 0 0 0 2.393 1.562c.456.26 1.09.668 1.904 1.22 6.153 3.907 10.091 7.195 11.817 9.864 1.074 1.725 1.888 3.695 2.441 5.908.586 2.181.879 4.558.879 7.13 0 7.519-1.953 13.313-5.859 17.382-3.907 4.07-9.489 6.104-16.748 6.104-7.618 0-13.347-1.937-17.188-5.81-3.809-3.907-5.713-9.701-5.713-17.384V55.1c.033-.554.098-1.416.195-2.588ZM525.348 47.19V33.615c0-8.333-.537-13.476-1.612-15.43-1.041-1.985-2.946-2.978-5.713-2.978-2.701 0-4.573 1.01-5.615 3.027-1.041 2.019-1.562 7.146-1.562 15.381V47.19c0 8.138.521 13.248 1.562 15.332 1.042 2.05 2.946 3.076 5.713 3.076 2.734 0 4.622-1.01 5.664-3.028 1.042-2.018 1.563-7.145 1.563-15.38Zm-32.422-6.788c0-9.05.325-15.657.976-19.824.651-4.166 1.726-7.422 3.223-9.765 2.148-3.32 4.964-5.778 8.447-7.374 3.483-1.627 7.666-2.441 12.549-2.441 4.915 0 9.082.814 12.5 2.441 3.451 1.596 6.25 4.053 8.399 7.373 1.562 2.377 2.669 5.648 3.32 9.815.651 4.167.976 10.758.976 19.775 0 8.985-.325 15.576-.976 19.776-.651 4.166-1.758 7.438-3.32 9.814-2.116 3.288-4.916 5.746-8.399 7.373-3.45 1.628-7.617 2.442-12.5 2.442s-9.066-.814-12.549-2.442c-3.483-1.627-6.299-4.085-8.447-7.373-1.497-2.344-2.572-5.599-3.223-9.765-.651-4.167-.976-10.775-.976-19.825ZM584.918 48.898h17.285c.033.456.049.944.049 1.465a40.6 40.6 0 0 1 .049 2.344c0 9.18-2.018 16-6.055 20.459-4.004 4.427-10.156 6.64-18.457 6.64-4.883 0-9.066-.813-12.549-2.44-3.483-1.628-6.299-4.086-8.447-7.374-1.497-2.344-2.572-5.599-3.223-9.765-.651-4.167-.976-10.775-.976-19.825 0-9.05.325-15.657.976-19.824.651-4.166 1.726-7.422 3.223-9.765 2.116-3.256 4.899-5.697 8.35-7.325 3.45-1.66 7.568-2.49 12.353-2.49 8.236 0 14.404 2.295 18.506 6.885 4.134 4.557 6.201 11.393 6.201 20.508v.732l-17.09-.049c-.065-5.11-.651-8.691-1.758-10.742-1.106-2.083-2.962-3.125-5.566-3.125-2.832 0-4.769 1.27-5.81 3.809-1.042 2.506-1.563 9.163-1.563 19.97v1.416c0 11.621.521 18.75 1.563 21.387 1.041 2.604 2.978 3.906 5.81 3.906 2.637 0 4.476-.944 5.518-2.832 1.074-1.92 1.611-5.468 1.611-10.644v-3.32ZM612.457 78V60.812h17.334V78h-17.334Z"
					fill="#fff"
				/></svg
			>
		</div>
	</div>
{/if}

<style>
	.splashscreen {
		position: fixed;
		top: 0;
		left: 0;
		z-index: 50;
		width: 100vw;
		height: 100vh;
		background-color: var(--red);
	}

	.splashscreen-inner {
		padding: 5rem;
		position: relative;
		width: 100%;
		height: 100%;
	}

	.splash-image {
		position: absolute;
		width: auto;
		height: 90vh;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		display: none;
	}

	.splashscreen-logo {
		position: absolute;
		width: auto;
		height: auto;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		transition: opacity 0.5s ease-in-out;
		opacity: 0;
	}

	.splashscreen-logo.visible {
		opacity: 1;
	}

	.splash-image.visible {
		display: block;
	}
</style>
